<html>
<head>
<title>Testing in Python </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ç”¨Pythonæµ‹è¯•</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://testdriven.io/blog/testing-python/#0001-01-01">https://testdriven.io/blog/testing-python/#0001-01-01</a></blockquote><div><div class="blog-content long-content" data-local-nav-source="">
    <p>è‡ªåŠ¨åŒ–æµ‹è¯•ä¸€ç›´æ˜¯è½¯ä»¶å¼€å‘ä¸­çš„çƒ­é—¨è¯é¢˜ï¼Œä½†åœ¨æŒç»­é›†æˆå’Œå¾®æœåŠ¡æ—¶ä»£ï¼Œå®ƒè¢«è°ˆè®ºå¾—æ›´å¤šã€‚æœ‰è®¸å¤šå·¥å…·å¯ä»¥å¸®åŠ©æ‚¨åœ¨Pythoné¡¹ç›®ä¸­ç¼–å†™ã€è¿è¡Œå’Œè¯„ä¼°æµ‹è¯•ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å…¶ä¸­çš„å‡ ä¸ªã€‚</p>
<blockquote>
<p>æœ¬æ–‡æ˜¯<a href="/guides/complete-python/">å®Œæ•´Python </a>æŒ‡å—çš„ä¸€éƒ¨åˆ†:</p>
<ol>
<li><a href="/blog/python-environments/">ç°ä»£Pythonç¯å¢ƒâ€”â€”ä¾èµ–æ€§å’Œå·¥ä½œç©ºé—´ç®¡ç†</a></li>
<li><a href="/blog/testing-python/">Pythonä¸­çš„æµ‹è¯•</a>(æœ¬æ–‡ï¼)</li>
<li><a href="/blog/modern-tdd/">Pythonä¸­çš„ç°ä»£æµ‹è¯•é©±åŠ¨å¼€å‘</a></li>
<li><a href="/blog/python-code-quality/"> Pythonä»£ç è´¨é‡</a></li>
<li><a href="/blog/python-type-checking/"> Pythonç±»å‹æ£€æŸ¥</a></li>
<li><a href="/blog/documenting-python/">è®°å½•Pythonä»£ç å’Œé¡¹ç›®</a></li>
<li><a href="/blog/python-project-workflow/"> Pythoné¡¹ç›®å·¥ä½œæµç¨‹</a></li>
</ol>
</blockquote>



<h2 id="pytest">pytest</h2>
<p>è™½ç„¶Pythonæ ‡å‡†åº“é™„å¸¦äº†ä¸€ä¸ªåä¸ºâ€œnittestâ€çš„å•å…ƒæµ‹è¯•æ¡†æ¶ï¼Œä½†æ˜¯<a href="https://docs.pytest.org/"> pytest </a>æ˜¯æµ‹è¯•Pythonä»£ç çš„é¦–é€‰æµ‹è¯•æ¡†æ¶ã€‚</p>
<p>pytestè®©å®ƒå˜å¾—ç®€å•(è€Œä¸”æœ‰è¶£ï¼)æ¥ç¼–å†™ã€ç»„ç»‡å’Œè¿è¡Œæµ‹è¯•ã€‚ä¸Pythonæ ‡å‡†åº“ä¸­çš„unittestç›¸æ¯”ï¼Œpytest:</p>
<ol>
<li>éœ€è¦æ›´å°‘çš„æ ·æ¿ä»£ç ï¼Œå› æ­¤æ‚¨çš„æµ‹è¯•å¥—ä»¶å°†æ›´å…·å¯è¯»æ€§ã€‚</li>
<li>æ”¯æŒç®€å•çš„<code>assert</code>è¯­å¥ï¼Œä¸unittestä¸­çš„<code>assertSomething</code>æ–¹æ³•â€”â€”å¦‚<code>assertEquals</code>ã€<code>assertTrue</code>å’Œ<code>assertContains</code>â€”â€”ç›¸æ¯”ï¼Œå®ƒå¯è¯»æ€§æ›´å¥½ï¼Œä¹Ÿæ›´å®¹æ˜“è®°ä½ã€‚</li>
<li>æ›´æ–°æ›´é¢‘ç¹ï¼Œå› ä¸ºå®ƒä¸æ˜¯Pythonæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>é€šè¿‡å¤¹å…·ç³»ç»Ÿç®€åŒ–æµ‹è¯•çŠ¶æ€çš„è®¾ç½®å’Œæ‹†é™¤ã€‚</li>
<li>ä½¿ç”¨åŠŸèƒ½æ–¹æ³•ã€‚</li>
</ol>
<p>å¦å¤–ï¼Œä½¿ç”¨pytestï¼Œæ‚¨å¯ä»¥åœ¨æ‰€æœ‰Pythoné¡¹ç›®ä¸­ä¿æŒä¸€è‡´çš„é£æ ¼ã€‚å‡è®¾æ‚¨çš„å †æ ˆä¸­æœ‰ä¸¤ä¸ªwebåº”ç”¨ç¨‹åºâ€”â€”ä¸€ä¸ªç”¨Djangoæ„å»ºï¼Œå¦ä¸€ä¸ªç”¨Flaskæ„å»ºã€‚å¦‚æœæ²¡æœ‰pytestï¼Œæ‚¨å¾ˆå¯èƒ½ä¼šåˆ©ç”¨Djangoæµ‹è¯•æ¡†æ¶ä»¥åŠFlaskæ‰©å±•ï¼Œå¦‚Flask-Testingã€‚æ‰€ä»¥ï¼Œä½ çš„æµ‹è¯•å¥—ä»¶ä¼šæœ‰ä¸åŒçš„é£æ ¼ã€‚å¦ä¸€æ–¹é¢ï¼Œä½¿ç”¨pytestï¼Œä¸¤ä¸ªæµ‹è¯•å¥—ä»¶å°†å…·æœ‰ä¸€è‡´çš„é£æ ¼ï¼Œä½¿å¾—ä»ä¸€ä¸ªè·³åˆ°å¦ä¸€ä¸ªæ›´åŠ å®¹æ˜“ã€‚</p>
<p>pytestä¹Ÿæœ‰ä¸€ä¸ªå¤§å‹çš„ã€ç”±ç¤¾åŒºç»´æŠ¤çš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿã€‚</p>
<p>ä¸€äº›ä¾‹å­:</p>
<ul>
<li>pytest-django  -æä¾›äº†ä¸€å¥—ä¸“é—¨ç”¨äºæµ‹è¯•djangoåº”ç”¨ç¨‹åºçš„å·¥å…·</li>
<li>pytest-xdist  -ç”¨äºå¹¶è¡Œè¿è¡Œæµ‹è¯•</li>
<li>æ·»åŠ ä»£ç è¦†ç›–æ”¯æŒ</li>
<li><a href="https://github.com/pytest-dev/pytest-instafail"> pytest-instafail </a> -ç«‹å³æ˜¾ç¤ºæ•…éšœå’Œé”™è¯¯ï¼Œè€Œä¸æ˜¯ç­‰åˆ°è¿è¡Œç»“æŸ</li>
</ul>
<blockquote>
<p>è¦æŸ¥çœ‹å®Œæ•´çš„æ’ä»¶åˆ—è¡¨ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£ä¸­çš„<a href="https://docs.pytest.org/en/latest/reference/plugin_list.html">æ’ä»¶åˆ—è¡¨</a>ã€‚</p>
</blockquote>
<h2 id="mocking">å˜²å¼„çš„</h2>
<p>è‡ªåŠ¨åŒ–æµ‹è¯•åº”è¯¥æ˜¯å¿«é€Ÿçš„ã€éš”ç¦»çš„/ç‹¬ç«‹çš„ã€ç¡®å®šçš„/å¯é‡å¤çš„ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨éœ€è¦æµ‹è¯•å‘ç¬¬ä¸‰æ–¹APIå‘å‡ºå¤–éƒ¨HTTPè¯·æ±‚çš„ä»£ç ï¼Œæ‚¨åº”è¯¥çœŸæ­£æ¨¡æ‹Ÿè¯¥è¯·æ±‚ã€‚ä¸ºä»€ä¹ˆï¼Ÿå¦‚æœä½ ä¸çŸ¥é“ï¼Œé‚£ä¹ˆå…·ä½“çš„æµ‹è¯•å°†ä¼šæ˜¯-</p>
<ol>
<li>é€Ÿåº¦æ…¢ï¼Œå› ä¸ºå®ƒé€šè¿‡ç½‘ç»œå‘å‡ºHTTPè¯·æ±‚</li>
<li>å–å†³äºç¬¬ä¸‰æ–¹æœåŠ¡å’Œç½‘ç»œæœ¬èº«çš„é€Ÿåº¦</li>
<li>ä¸ç¡®å®šæ€§ï¼Œå› ä¸ºæ ¹æ®APIçš„å“åº”ï¼Œæµ‹è¯•å¯èƒ½ä¼šäº§ç”Ÿä¸åŒçš„ç»“æœ</li>
</ol>
<blockquote>
<p>æ¨¡ä»¿å…¶ä»–é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œä¹Ÿæ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œæ¯”å¦‚æ•°æ®åº“æŸ¥è¯¢å’Œå¼‚æ­¥ä»»åŠ¡ï¼Œå› ä¸ºè‡ªåŠ¨åŒ–æµ‹è¯•é€šå¸¸ä¼šåœ¨æ¯æ¬¡æäº¤åˆ°æºä»£ç æ§åˆ¶æ—¶é¢‘ç¹è¿è¡Œã€‚</p>
</blockquote>
<p>æ¨¡ä»¿æ˜¯æŒ‡åœ¨è¿è¡Œæ—¶ç”¨æ¨¡ä»¿å¯¹è±¡æ›¿æ¢çœŸå®å¯¹è±¡çš„è¡Œä¸ºã€‚å› æ­¤ï¼Œå½“è¢«æ¨¡ä»¿çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬åªæ˜¯è¿”å›ä¸€ä¸ªé¢„æœŸçš„å“åº”ï¼Œè€Œä¸æ˜¯é€šè¿‡ç½‘ç»œå‘é€ä¸€ä¸ªçœŸæ­£çš„HTTPè¯·æ±‚ã€‚</p>
<p>ä¾‹å¦‚:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">requests</span>


<span class="k">def</span> <span class="nf">get_my_ip</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">'http://ipinfo.io/json'</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'ip'</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_get_my_ip</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">my_ip</span> <span class="o">=</span> <span class="s1">'123.123.123.123'</span>

    <span class="k">class</span> <span class="nc">MockResponse</span><span class="p">:</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_body</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_body</span> <span class="o">=</span> <span class="n">json_body</span>

        <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_body</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
        <span class="n">requests</span><span class="p">,</span>
        <span class="s1">'get'</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">MockResponse</span><span class="p">({</span><span class="s1">'ip'</span><span class="p">:</span> <span class="n">my_ip</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">get_my_ip</span><span class="p">()</span> <span class="o">==</span> <span class="n">my_ip</span>
</code></pre></div>

<p>è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ</p>
<p>æˆ‘ä»¬ä½¿ç”¨pytestçš„<a href="https://docs.pytest.org/en/stable/monkeypatch.html"> monkeypatch </a> fixtureå°†æ‰€æœ‰ä»<code>requests</code>æ¨¡å—å¯¹<code>get</code>æ–¹æ³•çš„è°ƒç”¨æ›¿æ¢ä¸ºæ€»æ˜¯è¿”å›<code>MockedResponse</code>å®ä¾‹çš„<code>lambda</code>å›è°ƒã€‚</p>
<blockquote>
<p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸º<code>requests</code>è¿”å›ä¸€ä¸ª<a href="https://requests.readthedocs.io/en/latest/api/#requests.Response">å“åº”</a>å¯¹è±¡ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥ç”¨æ¥è‡ª<code>unittest.mock</code>æ¨¡å—çš„<a href="https://docs.python.org/3/library/unittest.mock.html#unittest.mock.create_autospec"> create_autospec </a>æ–¹æ³•æ¥ç®€åŒ–æµ‹è¯•ã€‚è¯¥æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…·æœ‰ä¸ä½œä¸ºå‚æ•°ä¼ é€’çš„å¯¹è±¡ç›¸åŒçš„å±æ€§å’Œæ–¹æ³•:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Response</span>


<span class="k">def</span> <span class="nf">get_my_ip</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">'http://ipinfo.io/json'</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'ip'</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_get_my_ip</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">my_ip</span> <span class="o">=</span> <span class="s1">'123.123.123.123'</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">create_autospec</span><span class="p">(</span><span class="n">Response</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'ip'</span><span class="p">:</span> <span class="n">my_ip</span><span class="p">}</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
        <span class="n">requests</span><span class="p">,</span>
        <span class="s1">'get'</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">response</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">get_my_ip</span><span class="p">()</span> <span class="o">==</span> <span class="n">my_ip</span>
</code></pre></div>

<p>å°½ç®¡pytestæ¨èä½¿ç”¨monkeypatchæ–¹æ³•è¿›è¡Œæ¨¡ä»¿ï¼Œä½†æ˜¯æ ‡å‡†åº“ä¸­çš„<a href="https://github.com/pytest-dev/pytest-mock/"> pytest-mock </a>æ‰©å±•å’Œæ™®é€šçš„<a href="https://docs.python.org/3/library/unittest.mock.html"> unittest.mock </a>åº“ä¹Ÿæ˜¯ä¸é”™çš„æ–¹æ³•ã€‚</p>
<h2 id="code-coverage">ä»£ç è¦†ç›–ç‡</h2>
<p>æµ‹è¯•çš„å¦ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯ä»£ç è¦†ç›–ç‡ã€‚è¿™æ˜¯ä¸€ä¸ªæŒ‡æ ‡ï¼Œå®ƒå‘Šè¯‰ä½ åœ¨æµ‹è¯•è¿è¡ŒæœŸé—´æ‰§è¡Œçš„è¡Œæ•°ä¸ä½ çš„ä»£ç åº“ä¸­æ‰€æœ‰è¡Œçš„æ€»æ•°ä¹‹é—´çš„æ¯”ç‡ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨pytest-covæ’ä»¶ï¼Œå®ƒé›†æˆäº†pytestå’ŒT2çš„è¦†ç›–ç‡ã€‚</p>
<p>å®‰è£…åï¼Œè¦è¿è¡Œè¦†ç›–æŠ¥å‘Šæµ‹è¯•ï¼Œæ·»åŠ <code>--cov</code>é€‰é¡¹ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<div class="codehilite"><pre><span/><code>$ python -m pytest --cov<span class="o">=</span>.
</code></pre></div>

<p>å®ƒå°†äº§ç”Ÿå¦‚ä¸‹è¾“å‡º:</p>
<div class="codehilite"><pre><span/><code><span class="o">==================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==================================</span>
platform linux -- Python <span class="m">3</span>.7.9, pytest-5.4.3, py-1.9.0, pluggy-0.13.1
rootdir: /home/johndoe/sample-project
plugins: cov-2.10.1
collected <span class="m">6</span> items

tests/test_sample_project.py ....                                             <span class="o">[</span> <span class="m">66</span>%<span class="o">]</span>
tests/test_sample_project_mock.py .                                           <span class="o">[</span> <span class="m">83</span>%<span class="o">]</span>
tests/test_sample_project_mock_1.py .                                         <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

----------- coverage: platform linux, python <span class="m">3</span>.7.9-final-0 -----------
Name                                  Stmts   Miss  Cover
---------------------------------------------------------
sample_project/__init__.py                <span class="m">1</span>      <span class="m">1</span>     <span class="m">0</span>%
tests/__init__.py                         <span class="m">0</span>      <span class="m">0</span>   <span class="m">100</span>%
tests/test_sample_project.py              <span class="m">5</span>      <span class="m">0</span>   <span class="m">100</span>%
tests/test_sample_project_mock.py        <span class="m">13</span>      <span class="m">0</span>   <span class="m">100</span>%
tests/test_sample_project_mock_1.py      <span class="m">12</span>      <span class="m">0</span>   <span class="m">100</span>%
---------------------------------------------------------
TOTAL                                    <span class="m">31</span>      <span class="m">1</span>    <span class="m">97</span>%


<span class="o">==================================</span>  <span class="m">6</span> passed <span class="k">in</span> <span class="m">0</span>.13s <span class="o">==================================</span>
</code></pre></div>

<p>å¯¹äºé¡¹ç›®è·¯å¾„ä¸­çš„æ¯ä¸ªæ–‡ä»¶ï¼Œæ‚¨å°†è·å¾—:</p>
<ul>
<li>Stmts -ä»£ç è¡Œæ•°</li>
<li>missâ€”â€”æµ‹è¯•æ²¡æœ‰æ‰§è¡Œçš„è¡Œæ•°</li>
<li>Cover -æ–‡ä»¶çš„è¦†ç›–ç‡</li>
</ul>
<p>åœ¨åº•éƒ¨ï¼Œæœ‰ä¸€è¡Œæ˜¯æ•´ä¸ªé¡¹ç›®çš„æ€»æ•°ã€‚</p>
<p>è¯·è®°ä½ï¼Œå°½ç®¡é¼“åŠ±å®ç°é«˜è¦†ç›–ç‡ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ä½ çš„æµ‹è¯•æ˜¯å¥½çš„æµ‹è¯•ï¼Œæµ‹è¯•ä½ ä»£ç çš„æ¯ä¸€æ¡å¿«ä¹å’Œå¼‚å¸¸è·¯å¾„ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨åƒ<code>assert sum(3, 2) == 5</code>è¿™æ ·çš„æ–­è¨€çš„æµ‹è¯•å¯ä»¥è¾¾åˆ°å¾ˆé«˜çš„è¦†ç›–ç‡ï¼Œä½†æ˜¯ä½ çš„ä»£ç å®é™…ä¸Šä»ç„¶æ²¡æœ‰ç»è¿‡æµ‹è¯•ï¼Œå› ä¸ºå¼‚å¸¸è·¯å¾„æ²¡æœ‰è¢«è¦†ç›–ã€‚</p>
<h2 id="mutation-testing">çªå˜æµ‹è¯•</h2>
<p>å˜å¼‚æµ‹è¯•æœ‰åŠ©äºç¡®ä¿æ‚¨çš„æµ‹è¯•å®é™…ä¸Šè¦†ç›–äº†ä»£ç çš„å…¨éƒ¨è¡Œä¸ºã€‚æ¢å¥è¯è¯´ï¼Œå®ƒåˆ†ææµ‹è¯•å¥—ä»¶çš„æœ‰æ•ˆæ€§æˆ–å¥å£®æ€§ã€‚åœ¨çªå˜æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ªå·¥å…·ä¼šéå†æºä»£ç çš„æ¯ä¸€è¡Œï¼Œåšå‡ºä¸€äº›å°çš„æ”¹å˜(ç§°ä¸ºçªå˜)æ¥ç ´åä½ çš„ä»£ç ã€‚åœ¨æ¯ä¸€æ¬¡å˜å¼‚ä¹‹åï¼Œè¯¥å·¥å…·éƒ½ä¼šè¿è¡Œæ‚¨çš„å•å…ƒæµ‹è¯•ï¼Œå¹¶æ£€æŸ¥æ‚¨çš„æµ‹è¯•æ˜¯å¦å¤±è´¥ã€‚å¦‚æœæ‚¨çš„æµ‹è¯•ä»ç„¶é€šè¿‡ï¼Œé‚£ä¹ˆæ‚¨çš„ä»£ç æ²¡æœ‰é€šè¿‡å˜å¼‚æµ‹è¯•ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨æœ‰ä»¥ä¸‹ä»£ç :</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">50</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">100</span>
</code></pre></div>

<p>å˜å¼‚å·¥å…·å¯èƒ½ä¼šå°†è¿ç®—ç¬¦ä»<code>&gt;</code>æ”¹ä¸º<code>&gt;=</code>ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<div class="codehilite"><pre><span/><code><span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">y</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">50</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">100</span>
</code></pre></div>

<p>mutmutæ˜¯Pythonçš„ä¸€ä¸ªå˜å¼‚æµ‹è¯•åº“ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„è¿è¡Œæƒ…å†µã€‚</p>
<p>å‡è®¾æ‚¨æœ‰ä¸‹é¢çš„<code>Loan</code>ç±»:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># loan.py</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>


<span class="k">class</span> <span class="nc">LoanStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">"PENDING"</span>
    <span class="n">ACCEPTED</span> <span class="o">=</span> <span class="s2">"ACCEPTED"</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="s2">"REJECTED"</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Loan</span><span class="p">:</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">LoanStatus</span> <span class="o">=</span> <span class="n">LoanStatus</span><span class="o">.</span><span class="n">PENDING</span>

    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">LoanStatus</span><span class="o">.</span><span class="n">REJECTED</span>

    <span class="k">def</span> <span class="nf">rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LoanStatus</span><span class="o">.</span><span class="n">REJECTED</span>
</code></pre></div>

<p>ç°åœ¨ï¼Œå‡è®¾æ‚¨æƒ³è¦è‡ªåŠ¨æ‹’ç»è¶…è¿‡250ï¼Œ000çš„è´·æ¬¾è¯·æ±‚:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># reject_loan.py</span>

<span class="k">def</span> <span class="nf">reject_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">250_000</span><span class="p">:</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">loan</span>
</code></pre></div>

<p>ç„¶åï¼Œæ‚¨ç¼–å†™äº†ä»¥ä¸‹æµ‹è¯•:</p>
<div class="codehilite"><pre><span/><code><span class="c1"># test_reject_loan.py</span>

<span class="kn">from</span> <span class="nn">loan</span> <span class="kn">import</span> <span class="n">Loan</span>
<span class="kn">from</span> <span class="nn">reject_loan</span> <span class="kn">import</span> <span class="n">reject_loan</span>


<span class="k">def</span> <span class="nf">test_reject_loan</span><span class="p">():</span>
    <span class="n">loan</span> <span class="o">=</span> <span class="n">Loan</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mi">100_000</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">reject_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span><span class="o">.</span><span class="n">rejected</span><span class="p">()</span>
</code></pre></div>

<p>å½“ä½ ç”¨mutmutè¿›è¡Œçªå˜æµ‹è¯•æ—¶ï¼Œä½ ä¼šçœ‹åˆ°ä½ æœ‰ä¸¤ä¸ªå­˜æ´»çš„çªå˜ä½“:</p>
<div class="codehilite"><pre><span/><code>$ mutmut run --paths-to-mutate reject_loan.py --tests-dir<span class="o">=</span>.

- Mutation testing starting -

These are the steps:
<span class="m">1</span>. A full <span class="nb">test</span> suite run will be made to make sure we
   can run the tests successfully and we know how long
   it takes <span class="o">(</span>to detect infinite loops <span class="k">for</span> example<span class="o">)</span>
<span class="m">2</span>. Mutants will be generated and checked

Results are stored <span class="k">in</span> .mutmut-cache.
Print found mutants with <span class="sb">`</span>mutmut results<span class="sb">`</span>.

Legend <span class="k">for</span> output:
ğŸ‰ Killed mutants.   The goal is <span class="k">for</span> everything to end up <span class="k">in</span> this bucket.
â° Timeout.          Test suite took <span class="m">10</span> <span class="nb">times</span> as long as the baseline so were killed.
ğŸ¤” Suspicious.       Tests took a long time, but not long enough to be fatal.
ğŸ™ Survived.         This means your tests needs to be expanded.
ğŸ”‡ Skipped.          Skipped.

<span class="m">1</span>. Running tests without mutations
â  Running...Done

<span class="m">2</span>. Checking mutants
â ¸ <span class="m">2</span>/2  ğŸ‰ <span class="m">0</span>  â° <span class="m">0</span>  ğŸ¤” <span class="m">0</span>  ğŸ™ <span class="m">2</span>  ğŸ”‡ <span class="m">0</span>
</code></pre></div>

<p>ä½ å¯ä»¥é€šè¿‡IDæŸ¥çœ‹å¹¸å­˜çš„å˜ç§äºº:</p>
<div class="codehilite"><pre><span/><code>$ mutmut show <span class="m">1</span>

--- reject_loan.py
+++ reject_loan.py
@@ -1,7 +1,7 @@
 <span class="c1"># reject_loan.py</span>

 def reject_loan<span class="o">(</span>loan<span class="o">)</span>:
-    <span class="k">if</span> loan.amount &gt; 250_000:
+    <span class="k">if</span> loan.amount &gt;<span class="o">=</span> 250_000:
         loan.reject<span class="o">()</span>

     <span class="k">return</span> loan
</code></pre></div>

<div class="codehilite"><pre><span/><code>$ mutmut show <span class="m">2</span>

--- reject_loan.py
+++ reject_loan.py
@@ -1,7 +1,7 @@
 <span class="c1"># reject_loan.py</span>

 def reject_loan<span class="o">(</span>loan<span class="o">)</span>:
-    <span class="k">if</span> loan.amount &gt; 250_000:
+    <span class="k">if</span> loan.amount &gt; <span class="m">250001</span>:
         loan.reject<span class="o">()</span>

     <span class="k">return</span> loan
</code></pre></div>

<p>æ”¹è¿›æ‚¨çš„æµ‹è¯•:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">loan</span> <span class="kn">import</span> <span class="n">Loan</span>
<span class="kn">from</span> <span class="nn">reject_loan</span> <span class="kn">import</span> <span class="n">reject_loan</span>


<span class="k">def</span> <span class="nf">test_reject_loan</span><span class="p">():</span>
    <span class="n">loan</span> <span class="o">=</span> <span class="n">Loan</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mi">100_000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">reject_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span><span class="o">.</span><span class="n">rejected</span><span class="p">()</span>

    <span class="n">loan</span> <span class="o">=</span> <span class="n">Loan</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mi">250_001</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">reject_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span><span class="o">.</span><span class="n">rejected</span><span class="p">()</span>

    <span class="n">loan</span> <span class="o">=</span> <span class="n">Loan</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mi">250_000</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">reject_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span><span class="o">.</span><span class="n">rejected</span><span class="p">()</span>
</code></pre></div>

<p>å¦‚æœä½ å†æ¬¡è¿›è¡Œçªå˜æµ‹è¯•ï¼Œä½ ä¼šå‘ç°æ²¡æœ‰çªå˜å­˜æ´»ä¸‹æ¥:</p>
<div class="codehilite"><pre><span/><code>$ mutmut run --paths-to-mutate reject_loan.py --tests-dir<span class="o">=</span>.

- Mutation testing starting -

These are the steps:
<span class="m">1</span>. A full <span class="nb">test</span> suite run will be made to make sure we
   can run the tests successfully and we know how long
   it takes <span class="o">(</span>to detect infinite loops <span class="k">for</span> example<span class="o">)</span>
<span class="m">2</span>. Mutants will be generated and checked

Results are stored <span class="k">in</span> .mutmut-cache.
Print found mutants with <span class="sb">`</span>mutmut results<span class="sb">`</span>.

Legend <span class="k">for</span> output:
ğŸ‰ Killed mutants.   The goal is <span class="k">for</span> everything to end up <span class="k">in</span> this bucket.
â° Timeout.          Test suite took <span class="m">10</span> <span class="nb">times</span> as long as the baseline so were killed.
ğŸ¤” Suspicious.       Tests took a long time, but not long enough to be fatal.
ğŸ™ Survived.         This means your tests needs to be expanded.
ğŸ”‡ Skipped.          Skipped.

<span class="m">1</span>. Running tests without mutations
â  Running...Done

<span class="m">2</span>. Checking mutants
â ™ <span class="m">2</span>/2  ğŸ‰ <span class="m">2</span>  â° <span class="m">0</span>  ğŸ¤” <span class="m">0</span>  ğŸ™ <span class="m">0</span>  ğŸ”‡ <span class="m">0</span>
</code></pre></div>

<p>ç°åœ¨æ‚¨çš„æµ‹è¯•æ›´åŠ å¥å£®äº†ã€‚åœ¨<em> reject_loan.py </em>ä¸­çš„ä»»ä½•æ— æ„çš„æ”¹å˜éƒ½ä¼šå¯¼è‡´æµ‹è¯•å¤±è´¥ã€‚</p>
<blockquote>
<p>Pythonçš„å˜å¼‚æµ‹è¯•å·¥å…·ä¸åƒå…¶ä»–ä¸€äº›å·¥å…·é‚£æ ·æˆç†Ÿã€‚æ¯”å¦‚<a href="https://github.com/mbj/mutant">çªå˜ä½“</a>å°±æ˜¯Rubyçš„ä¸€ä¸ªæˆç†Ÿçš„çªå˜æµ‹è¯•å·¥å…·ã€‚è¦äº†è§£æ›´å¤šå…³äºçªå˜æµ‹è¯•çš„çŸ¥è¯†ï¼Œè¯·åœ¨<a href="https://twitter.com/_m_b_j_">æ¨ç‰¹</a>ä¸Šå…³æ³¨çªå˜ä½œè€…ã€‚</p>
</blockquote>
<p>ä¸ä»»ä½•å…¶ä»–æ–¹æ³•ä¸€æ ·ï¼Œçªå˜æµ‹è¯•ä¹Ÿæœ‰ä¸€ä¸ªæƒè¡¡ã€‚è™½ç„¶å®ƒæé«˜äº†æµ‹è¯•å¥—ä»¶æ•æ‰bugçš„èƒ½åŠ›ï¼Œä½†å®ƒæ˜¯ä»¥é€Ÿåº¦ä¸ºä»£ä»·çš„ï¼Œå› ä¸ºæ‚¨å¿…é¡»è¿è¡Œæ•´ä¸ªæµ‹è¯•å¥—ä»¶æ•°ç™¾æ¬¡ã€‚å®ƒä¹Ÿè¿«ä½¿ä½ çœŸæ­£åœ°æµ‹è¯•ä¸€åˆ‡ã€‚è¿™æœ‰åŠ©äºå‘ç°å¼‚å¸¸è·¯å¾„ï¼Œä½†æ˜¯æ‚¨å°†æœ‰æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹éœ€è¦ç»´æŠ¤ã€‚</p>
<h2 id="hypothesis">å‡è®¾</h2>
<p><a href="https://hypothesis.readthedocs.io/en/latest/">å‡è®¾</a>æ˜¯åœ¨Pythonä¸­è¿›è¡Œ<a href="https://hypothesis.works/articles/what-is-property-based-testing/">åŸºäºå±æ€§çš„æµ‹è¯•</a>çš„åº“ã€‚åŸºäºå±æ€§çš„æµ‹è¯•ä¸éœ€è¦ä¸ºæ¯ä¸€ä¸ªä½ æƒ³è¦æµ‹è¯•çš„å‚æ•°ç¼–å†™ä¸åŒçš„æµ‹è¯•ç”¨ä¾‹ï¼Œå®ƒä¼šç”Ÿæˆå¤§é‡çš„éšæœºæµ‹è¯•æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¾èµ–äºä¹‹å‰çš„æµ‹è¯•è¿è¡Œã€‚è¿™æœ‰åŠ©äºå¢åŠ æµ‹è¯•å¥—ä»¶çš„å¥å£®æ€§ï¼ŒåŒæ—¶å‡å°‘æµ‹è¯•å†—ä½™ã€‚ç®€è€Œè¨€ä¹‹ï¼Œæ‚¨çš„æµ‹è¯•ä»£ç å°†ä¼šæ›´å¹²å‡€ã€æ›´ç®€æ´ï¼Œå¹¶ä¸”æ€»ä½“ä¸Šæ›´é«˜æ•ˆï¼ŒåŒæ—¶ä»ç„¶è¦†ç›–äº†å¹¿æ³›çš„æµ‹è¯•æ•°æ®ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨å¿…é¡»ä¸ºä»¥ä¸‹å‡½æ•°ç¼–å†™æµ‹è¯•:</p>
<div class="codehilite"><pre><span/><code><span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>

<p>æ‚¨å¯ä»¥ç¼–å†™ä»¥ä¸‹æµ‹è¯•:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s1">'number, result'</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">101234</span><span class="p">,</span> <span class="mi">101235</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_increment</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">increment</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">==</span> <span class="n">result</span>
</code></pre></div>

<p>è¿™ç§æ–¹æ³•æ²¡æœ‰é”™ã€‚æ‚¨çš„ä»£ç å·²ç»è¿‡æµ‹è¯•ï¼Œä»£ç è¦†ç›–ç‡å¾ˆé«˜(å‡†ç¡®åœ°è¯´æ˜¯100%)ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸºäºå¯èƒ½çš„è¾“å…¥èŒƒå›´ï¼Œæ‚¨çš„ä»£ç æµ‹è¯•å¾—æœ‰å¤šå¥½ï¼Ÿæœ‰ç›¸å½“å¤šçš„æ•´æ•°å¯ä»¥æµ‹è¯•ï¼Œä½†æ˜¯æµ‹è¯•ä¸­åªä½¿ç”¨äº†å…¶ä¸­çš„å››ä¸ªã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™å°±è¶³å¤Ÿäº†ã€‚åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œå››ç§æƒ…å†µæ˜¯ä¸å¤Ÿçš„â€”â€”å³éç¡®å®šæ€§æœºå™¨å­¦ä¹ ä»£ç ã€‚é‚£äº›éå¸¸å°æˆ–éå¸¸å¤§çš„æ•°å­—å‘¢ï¼Ÿæˆ–è€…å‡è®¾æ‚¨çš„å‡½æ•°æ¥å—ä¸€ä¸ªæ•´æ•°åˆ—è¡¨è€Œä¸æ˜¯å•ä¸ªæ•´æ•°â€”â€”å¦‚æœè¿™ä¸ªåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œæˆ–è€…å®ƒåŒ…å«ä¸€ä¸ªå…ƒç´ ã€æ•°ç™¾ä¸ªå…ƒç´ æˆ–æ•°åƒä¸ªå…ƒç´ å‘¢ï¼Ÿåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ ¹æœ¬æ— æ³•æä¾›(æ›´ä¸ç”¨è¯´ç”šè‡³æƒ³å‡º)æ‰€æœ‰å¯èƒ½çš„æƒ…å†µã€‚è¿™å°±æ˜¯åŸºäºå±æ€§çš„æµ‹è¯•å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p>
<blockquote>
<p>æœºå™¨å­¦ä¹ ç®—æ³•æ˜¯åŸºäºå±æ€§çš„æµ‹è¯•çš„ä¸€ä¸ªå¾ˆå¥½çš„ç”¨ä¾‹ï¼Œå› ä¸ºå¾ˆéš¾ä¸ºå¤æ‚çš„æ•°æ®é›†äº§ç”Ÿ(å’Œç»´æŠ¤)æµ‹è¯•å®ä¾‹ã€‚</p>
</blockquote>
<p>åƒå‡è¯´è¿™æ ·çš„æ¡†æ¶æä¾›äº†ç”Ÿæˆéšæœºæµ‹è¯•æ•°æ®çš„æ–¹æ³•(å‡è¯´ç§°ä¹‹ä¸º<a href="https://hypothesis.readthedocs.io/en/latest/data.html?#core-strategies">ç­–ç•¥</a>)ã€‚å‡è®¾è¿˜å­˜å‚¨ä»¥å‰æµ‹è¯•è¿è¡Œçš„ç»“æœï¼Œå¹¶ä½¿ç”¨å®ƒä»¬æ¥åˆ›å»ºæ–°çš„æ¡ˆä¾‹ã€‚</p>
<blockquote>
<p>ç­–ç•¥æ˜¯åŸºäºè¾“å…¥æ•°æ®çš„å½¢çŠ¶ç”Ÿæˆä¼ªéšæœºæ•°æ®çš„ç®—æ³•ã€‚å®ƒæ˜¯ä¼ªéšæœºçš„ï¼Œå› ä¸ºç”Ÿæˆçš„æ•°æ®æ˜¯åŸºäºä»¥å‰æµ‹è¯•çš„æ•°æ®ã€‚</p>
</blockquote>
<p>é€šè¿‡å‡è®¾ä½¿ç”¨åŸºäºå±æ€§çš„æµ‹è¯•çš„ç›¸åŒæµ‹è¯•å¦‚ä¸‹æ‰€ç¤º:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span>
<span class="kn">import</span> <span class="nn">hypothesis.strategies</span> <span class="k">as</span> <span class="nn">st</span>


<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">test_add_one</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">increment</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">==</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>

<p><code>st.integers()</code>æ˜¯ä¸€ç§å‡è®¾ç­–ç•¥ï¼Œå®ƒç”Ÿæˆç”¨äºæµ‹è¯•çš„éšæœºæ•´æ•°ï¼Œè€Œ<code>@given</code>è£…é¥°å™¨ç”¨äºå‚æ•°åŒ–æµ‹è¯•å‡½æ•°ã€‚å› æ­¤ï¼Œå½“è°ƒç”¨æµ‹è¯•å‡½æ•°æ—¶ï¼Œä»ç­–ç•¥ä¸­ç”Ÿæˆçš„æ•´æ•°å°†è¢«ä¼ é€’åˆ°æµ‹è¯•ä¸­ã€‚</p>
<div class="codehilite"><pre><span/><code>$ python -m pytest test_hypothesis.py --hypothesis-show-statistics

<span class="o">==================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===================================</span>
platform darwin -- Python <span class="m">3</span>.8.5, pytest-6.1.1, py-1.9.0, pluggy-0.13.1
rootdir: /home/johndoe/sample-project
plugins: hypothesis-5.37.3
collected <span class="m">1</span> item

test_hypothesis.py .                                                               <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>
<span class="o">=================================</span> Hypothesis <span class="nv">Statistics</span> <span class="o">==================================</span>

test_hypothesis.py::test_add_one:

  - during generate phase <span class="o">(</span><span class="m">0</span>.06 seconds<span class="o">)</span>:
    - Typical runtimes: &lt; 1ms, ~ <span class="m">50</span>% <span class="k">in</span> data generation
    - <span class="m">100</span> passing examples, <span class="m">0</span> failing examples, <span class="m">0</span> invalid examples

  - Stopped because settings.max_examples<span class="o">=</span><span class="nv">100</span>


<span class="o">===================================</span> <span class="m">1</span> passed <span class="k">in</span> <span class="m">0</span>.08s <span class="o">====================================</span>
</code></pre></div>

<h2 id="type-checking">ç±»å‹æ£€æŸ¥</h2>
<p>æµ‹è¯•æ˜¯ä»£ç ï¼Œå®ƒä»¬åº”è¯¥è¢«å¦‚æ­¤å¯¹å¾…ã€‚å°±åƒæ‚¨çš„ä¸šåŠ¡ä»£ç ä¸€æ ·ï¼Œæ‚¨éœ€è¦ç»´æŠ¤å’Œé‡æ„å®ƒä»¬ã€‚ä½ ç”šè‡³å¯èƒ½éœ€è¦æ—¶ä¸æ—¶åœ°å¤„ç†ä¸€äº›bugã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œä¿æŒä½ çš„æµ‹è¯•ç®€çŸ­ã€ç®€å•ã€ç›´æˆªäº†å½“æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚æ‚¨è¿˜åº”è¯¥æ³¨æ„ä¸è¦è¿‡åº¦æµ‹è¯•æ‚¨çš„ä»£ç ã€‚</p>
<p>è¿è¡Œæ—¶(æˆ–åŠ¨æ€)ç±»å‹çš„æ£€æŸ¥å™¨ï¼Œå¦‚<a href="https://typeguard.readthedocs.io/"> Typeguard </a>å’Œ<a href="https://pydantic-docs.helpmanual.io/"> pydantic </a>ï¼Œå¯ä»¥å¸®åŠ©æœ€å°åŒ–æµ‹è¯•çš„æ•°é‡ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªpydanticçš„ä¾‹å­ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå±æ€§çš„<code>User</code>ï¼Œä¸€ä¸ªç”µå­é‚®ä»¶åœ°å€:</p>
<div class="codehilite"><pre><span/><code><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>


<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bbd1d4d3d5fbdfd4de95d8d4d6">[emailÂ protected]</a>'</span><span class="p">)</span>
</code></pre></div>

<p>æˆ‘ä»¬å¸Œæœ›ç¡®ä¿æ‰€æä¾›çš„ç”µå­é‚®ä»¶ç¡®å®æ˜¯æœ‰æ•ˆçš„ç”µå­é‚®ä»¶åœ°å€ã€‚å› æ­¤ï¼Œä¸ºäº†éªŒè¯å®ƒï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æŸä¸ªåœ°æ–¹æ·»åŠ ä¸€äº›åŠ©æ‰‹ä»£ç ã€‚é™¤äº†ç¼–å†™æµ‹è¯•ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»èŠ±æ—¶é—´ä¸ºæ­¤ç¼–å†™æ­£åˆ™è¡¨è¾¾å¼ã€‚pydanticå¯ä»¥å¸®åŠ©è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å®šä¹‰æˆ‘ä»¬çš„<code>User</code>æ¨¡å‹:</p>
<div class="codehilite"><pre><span/><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>


<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">'<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="ddb7b2b5b39db9b2b8f3beb2b0">[emailÂ protected]</a>'</span><span class="p">)</span>
</code></pre></div>

<p>ç°åœ¨ï¼Œåœ¨åˆ›å»ºæ¯ä¸ªæ–°çš„<code>User</code>å®ä¾‹ä¹‹å‰ï¼Œpydanticå°†éªŒè¯emailå‚æ•°ã€‚å½“å®ƒä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ç”µå­é‚®ä»¶-å³<code>User(email='something')</code> -ä¸€ä¸ª<a href="https://pydantic-docs.helpmanual.io/usage/models/#error-handling">éªŒè¯é”™è¯¯</a>å°†è¢«æå‡ºã€‚è¿™æ¶ˆé™¤äº†ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„éªŒè¯å™¨çš„éœ€è¦ã€‚æˆ‘ä»¬ä¹Ÿä¸éœ€è¦æµ‹è¯•å®ƒï¼Œå› ä¸ºpydantic <a href="https://github.com/samuelcolvin/pydantic/blob/ab671a36708a14017e2ccc62f72c9f7628628737/tests/test_types.py">çš„ç»´æŠ¤è€…ä¸ºæˆ‘ä»¬å¤„ç†äº†</a>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å‡å°‘å¯¹ä»»ä½•ç”¨æˆ·æä¾›çš„æ•°æ®è¿›è¡Œæµ‹è¯•çš„æ¬¡æ•°ã€‚ç›¸åï¼Œæˆ‘ä»¬åªéœ€è¦æµ‹è¯•æ˜¯å¦æ­£ç¡®å¤„ç†äº†<code>ValidationError</code>ã€‚</p>
<p>è®©æˆ‘ä»¬çœ‹çœ‹Flaskåº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ªç®€å•ä¾‹å­:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_validation_exception</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">errors</span><span class="p">())</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="n">author</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>

<p>æµ‹è¯•:</p>
<div class="codehilite"><pre><span/><code><span class="kn">import</span> <span class="nn">json</span>


<span class="k">def</span> <span class="nf">test_create_blog_bad_request</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    GIVEN request data with invalid values or missing attributes</span>
<span class="sd">    WHEN endpoint /create-blog/ is called</span>
<span class="sd">    THEN it should return status 400 and JSON body</span>
<span class="sd">    """</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">'/create-blog/'</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
            <span class="s1">'author'</span><span class="p">:</span> <span class="s1">'John Doe'</span><span class="p">,</span>
            <span class="s1">'title'</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">'content'</span><span class="p">:</span> <span class="s1">'Some extra awesome content'</span>
        <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">'application/json'</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>

<h2 id="conclusion">ç»“è®º</h2>
<p>æµ‹è¯•å¸¸å¸¸è®©äººè§‰å¾—æ˜¯ä¸€é¡¹ä»¤äººç•æƒ§çš„ä»»åŠ¡ã€‚æ€»æœ‰è¿™æ ·çš„æ—¶å€™ï¼Œä½†æ˜¯å¸Œæœ›è¿™ç¯‡æ–‡ç« æä¾›äº†ä¸€äº›å·¥å…·ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥ä½¿æµ‹è¯•å˜å¾—æ›´å®¹æ˜“ã€‚å°†æ‚¨çš„æµ‹è¯•å·¥ä½œé›†ä¸­åœ¨å‡å°‘å¤æ€ªçš„æµ‹è¯•ä¸Šã€‚ä½ çš„æµ‹è¯•ä¹Ÿåº”è¯¥æ˜¯å¿«é€Ÿçš„ï¼Œéš”ç¦»çš„/ç‹¬ç«‹çš„ï¼Œç¡®å®šçš„/å¯é‡å¤çš„ã€‚æœ€åï¼Œå¯¹æ‚¨çš„æµ‹è¯•å¥—ä»¶æœ‰ä¿¡å¿ƒå°†å¸®åŠ©æ‚¨æ›´é¢‘ç¹åœ°éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œæœ‰åŠ©äºæ‚¨æ™šä¸Šç¡è§‰ã€‚</p>
<p>æµ‹è¯•æ„‰å¿«ï¼</p>
<blockquote>
<p><a href="/guides/complete-python/">å®Œæ•´Python </a>æŒ‡å—:</p>
<ol>
<li><a href="/blog/python-environments/">ç°ä»£Pythonç¯å¢ƒâ€”â€”ä¾èµ–æ€§å’Œå·¥ä½œç©ºé—´ç®¡ç†</a></li>
<li><a href="/blog/testing-python/">Pythonä¸­çš„æµ‹è¯•</a>(æœ¬æ–‡ï¼)</li>
<li><a href="/blog/modern-tdd/">Pythonä¸­çš„ç°ä»£æµ‹è¯•é©±åŠ¨å¼€å‘</a></li>
<li><a href="/blog/python-code-quality/"> Pythonä»£ç è´¨é‡</a></li>
<li><a href="/blog/python-type-checking/"> Pythonç±»å‹æ£€æŸ¥</a></li>
<li><a href="/blog/documenting-python/">è®°å½•Pythonä»£ç å’Œé¡¹ç›®</a></li>
<li><a href="/blog/python-project-workflow/"> Pythoné¡¹ç›®å·¥ä½œæµç¨‹</a></li>
</ol>
</blockquote>
  </div>

  </div>    
</body>
</html>